version: '{branch}-rev{build}'

branches:
  only:
    - master
    - development
    - appveyor

max_jobs: 2

image:
  - Visual Studio 2017
  - Ubuntu1804

platform:
  - x64

configuration:
  - Release

install:
  - git submodule init
  - git submodule update --init -- "source/CMake"
  - git submodule update --recursive --init -- "source/external/Ashes"
  - git submodule update --init -- "source/external/FreeType"
  - git submodule update --init -- "source/external/zlib"
  - git submodule update --recursive --init -- "source/external/ShaderWriter"
  - git submodule update --init -- "source/external/glslang"
  - git submodule update --init -- "dependencies"
  - ps: $PLATFORM_NAME="x64"
  - ps: if ($isLinux) {$GENERATOR_NAME="Unix Makefiles"} else {$GENERATOR_NAME="Visual Studio 15 2017 Win64"}
  - ps: if ($isLinux) {$OS_NAME="linux"} else {$OS_NAME="win32"}
  - ps: if ($isLinux) {$PROJECT_DIR="/home/appveyor/projects/castor3d"} else {$PROJECT_DIR="C:\projects\castor3d"}
  - ps: if ($isLinux) {$INSTALL_PREFIX="$PROJECT_DIR/package/Castor3D"} else {$INSTALL_PREFIX="$PROJECT_DIR\package\Castor3D"}
  - ps: if ($isLinux) {$PROJECT_FILE="Makefile"} else {$PROJECT_FILE="Castor3D.sln"}
  - ps: if (!$isLinux) {cd $PROJECT_DIR\dependencies\vc14\$PLATFORM_NAME}
  - ps: if (!$isLinux) {7z x assimp-3.2-win32.zip}
  - ps: if (!$isLinux) {7z x wxWidgets-3.1.0-win32-headers.zip}
  - ps: if (!$isLinux) {7z x wxWidgets-3.1.0-win32-libs-release-update-4.3.zip}
  - ps: if (!$isLinux) {cd $PROJECT_DIR}
  - ps: md build
  - ps: cd build
  - ps: if ($isLinux) {cmake -Wno-dev -G "$GENERATOR_NAME" -DPROJECTS_OUTPUT_DIR=$PROJECT_DIR -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../source -DSDW_GENERATE_SOURCE=OFF -DCASTOR_BUILDGRP_DIVIDER=ON -DCASTOR_BUILDGRP_GENERATOR=ON -DCASTOR_BUILDGRP_GENERIC=ON -DCASTOR_BUILDGRP_IMPORTER=ON -DCASTOR_BUILDGRP_INTEROP=OFF -DCASTOR_BUILDGRP_PARTICLES=ON -DCASTOR_BUILDGRP_POSTFX=ON -DCASTOR_BUILDGRP_TONEMAPS=ON -DCASTOR_BUILDGRP_TEST=OFF -DCASTOR_BUILDGRP_RENDERER=OFF -DCASTOR_BUILDGRP_SAMPLE=OFF -DPROJECTS_USE_PRECOMPILED_HEADERS=OFF}
  - ps: if (!$isLinux) {cmake -Wno-dev -G "$GENERATOR_NAME" -DPROJECTS_OUTPUT_DIR=$PROJECT_DIR -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX ../source -DSDW_GENERATE_SOURCE=OFF -DCASTOR_BUILDGRP_DIVIDER=ON -DCASTOR_BUILDGRP_GENERATOR=ON -DCASTOR_BUILDGRP_GENERIC=ON -DCASTOR_BUILDGRP_IMPORTER=ON -DCASTOR_BUILDGRP_INTEROP=OFF -DCASTOR_BUILDGRP_PARTICLES=ON -DCASTOR_BUILDGRP_POSTFX=ON -DCASTOR_BUILDGRP_TONEMAPS=ON -DCASTOR_BUILDGRP_TEST=OFF -DCASTOR_BUILDGRP_RENDERER=ON -DCASTOR_BUILDGRP_SAMPLE=ON -DPROJECTS_USE_PRECOMPILED_HEADERS=ON -DCASTOR_BUILD_SAMPLE_CASTOR_TD=OFF -DCASTOR_BUILD_SAMPLE_CASTOR_VIEWER=ON}

build_script:
  - ps: cd $PROJECT_DIR/build
  - ps: if ($isLinux) {cmake --build . --parallel 4}
  - ps: if (!$isLinux) {cmake --build . --parallel 4 --config Release}

after_build:
  - ps: cd $PROJECT_DIR/build
  - ps: cmake --build . --target install --config Release
  - ps: cd ..
  - ps: 7z a Castor3D-$OS_NAME-$PLATFORM_NAME.zip .\package\Castor3D\*

artifacts:
  - path: Castor3D-$OS_NAME-$PLATFORM_NAME.zip
    name: Castor3D binaries $PLATFORM_NAME $OS_NAME
